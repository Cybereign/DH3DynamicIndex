<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DH3项目HelpMe索引表</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', 'Microsoft YaHei', sans-serif;
        }
    
        body {
            background-color: #f5f7fa;
            color: #333;
            line-height: 1.6;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
            overflow: hidden;
        }
        
        header {
            background: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%);
            color: white;
            padding: 25px 30px;
            text-align: center;
            position: relative;
        }
        
        .admin-indicator {
            position: absolute;
            top: 15px;
            right: 20px;
            background: rgba(255, 255, 255, 0.2);
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 0.8rem;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        h1 {
            font-size: 2.2rem;
            margin-bottom: 10px;
            font-weight: 600;
        }
        
        .subtitle {
            font-size: 1rem;
            opacity: 0.9;
        }
        
        .auth-section {
            padding: 15px 30px;
            background: #f8f9fa;
            border-bottom: 1px solid #eaeaea;
        }
        
        .auth-main-row {
            display: flex;
            align-items: center;
            gap: 40px;
            width: 100%;
            flex-wrap: wrap;
        }
        
        .login-form {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        .login-input {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 0.9rem;
        }
        
        .login-btn {
            padding: 8px 15px;
            background: #6a11cb;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
        }
        
        .login-btn:hover {
            background: #5a0db5;
        }
        
        .logout-btn {
            padding: 8px 15px;
            background: #dc3545;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
        }
        
        .logout-btn:hover {
            background: #c82333;
        }
        
        .user-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .config-info {
            font-size: 0.8rem;
            color: #666;
            margin-left: 10px;
        }
        
        /* GitHub令牌侧边布局 */
        .github-auth-side {
            display: flex;
            align-items: center;
            gap: 15px;
            flex: 1;
            min-width: 500px;
        }

        .token-input-group {
            display: flex;
            align-items: center;
            gap: 10px;
            flex: 1;
        }

        .token-input {
            width: 280px;
            min-width: 250px;
        }

        .token-btn {
            white-space: nowrap;
        }

        .token-hint {
            flex-shrink: 0;
        }
        
        .controls {
            padding: 20px 30px;
            background: #f8f9fa;
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            border-bottom: 1px solid #eaeaea;
        }
        
        .search-box {
            flex: 1;
            min-width: 250px;
            position: relative;
        }
        
        .search-box input {
            width: 100%;
            padding: 12px 20px 12px 40px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 1rem;
            transition: all 0.3s;
        }
        
        .search-box input:focus {
            outline: none;
            border-color: #6a11cb;
            box-shadow: 0 0 0 2px rgba(106, 17, 203, 0.2);
        }
        
        .search-icon {
            position: absolute;
            left: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: #888;
        }
        
        .filter-box {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .filter-btn {
            padding: 10px 18px;
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.9rem;
        }
        
        .filter-btn:hover {
            background: #f0f0f0;
        }
        
        .filter-btn.active {
            background: #6a11cb;
            color: white;
            border-color: #6a11cb;
        }
        
        .action-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .btn {
            padding: 10px 18px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .btn-primary {
            background: #6a11cb;
            color: white;
        }
        
        .btn-primary:hover {
            background: #5a0db5;
        }
        
        .btn-success {
            background: #28a745;
            color: white;
        }
        
        .btn-success:hover {
            background: #218838;
        }
        
        .btn-danger {
            background: #dc3545;
            color: white;
        }
        
        .btn-danger:hover {
            background: #c82333;
        }
        
        .btn-warning {
            background: #ffc107;
            color: #212529;
        }
        
        .btn-warning:hover {
            background: #e0a800;
        }
        
        .btn:disabled {
            background: #6c757d;
            cursor: not-allowed;
            opacity: 0.6;
        }
        
        .table-container {
            overflow-x: auto;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
        }
        
        thead {
            background: #f8f9fa;
        }
        
        th {
            padding: 16px 20px;
            text-align: left;
            font-weight: 600;
            color: #555;
            border-bottom: 2px solid #eaeaea;
            font-size: 0.95rem;
            position: relative;
        }
        
        .editable-header {
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .editable-header:hover {
            background: #e9ecef;
        }
        
        .editable-header .edit-icon {
            opacity: 0;
            margin-left: 5px;
            font-size: 0.8rem;
            transition: opacity 0.2s;
        }
        
        .editable-header:hover .edit-icon {
            opacity: 1;
        }
        
        td {
            padding: 16px 20px;
            border-bottom: 1px solid #eaeaea;
            font-size: 0.95rem;
        }
        
        tbody tr {
            transition: background 0.2s;
        }
        
        tbody tr:hover {
            background: #f8f9ff;
        }
        
        .category {
            display: inline-block;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 500;
        }
        
        .category-1 { background: #e3f2fd; color: #1976d2; }
        .category-2 { background: #e8f5e9; color: #388e3c; }
        .category-3 { background: #fff3e0; color: #f57c00; }
        .category-4 { background: #fce4ec; color: #c2185b; }
        .category-5 { background: #f3e5f5; color: #7b1fa2; }
        .category-6 { background: #e0f2f1; color: #00796b; }
        .category-7 { background: #fff8e1; color: #ff8f00; }
        .category-8 { background: #fbe9e7; color: #d84315; }
        .category-9 { background: #e8eaf6; color: #303f9f; }
        .category-10 { background: #e0f7fa; color: #0097a7; }
        
        .link {
            color: #2575fc;
            text-decoration: none;
            transition: color 0.2s;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .link:hover {
            color: #6a11cb;
            text-decoration: underline;
        }
        
        .link-icon {
            font-size: 0.9rem;
        }
        
        .folder-link {
            color: #28a745;
        }
        
        .folder-link:hover {
            color: #218838;
        }
        
        .note {
            color: #666;
            font-size: 0.9rem;
            white-space: pre-wrap;
            word-break: break-word;
            line-height: 1.4;
        }

        .empty-row {
            text-align: center;
            padding: 40px;
            color: #888;
        }
        
        .action-cell {
            display: flex;
            gap: 8px;
        }
        
        .action-btn {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 1rem;
            padding: 5px;
            border-radius: 4px;
            transition: all 0.2s;
        }
        
        .action-btn:disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }
        
        .edit-btn {
            color: #17a2b8;
        }
        
        .edit-btn:hover:not(:disabled) {
            background: #e6f7fa;
        }
        
        .delete-btn {
            color: #dc3545;
        }
        
        .delete-btn:hover:not(:disabled) {
            background: #fbe7e9;
        }
        
        .path-type-badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.7rem;
            margin-left: 8px;
            font-weight: 500;
        }
        
        .badge-url {
            background: #e3f2fd;
            color: #1976d2;
        }
        
        .badge-folder {
            background: #e8f5e9;
            color: #388e3c;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        
        .modal-content {
            background: white;
            border-radius: 12px;
            width: 90%;
            max-width: 600px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.2);
            overflow: hidden;
        }
        
        .modal-header {
            padding: 20px 25px;
            background: #f8f9fa;
            border-bottom: 1px solid #eaeaea;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .modal-title {
            font-size: 1.3rem;
            font-weight: 600;
        }
        
        .close-btn {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #6c757d;
        }
        
        .modal-body {
            padding: 25px;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #555;
        }
        
        .form-control {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 1rem;
            transition: all 0.3s;
        }
        
        .form-control:focus {
            outline: none;
            border-color: #6a11cb;
            box-shadow: 0 0 0 2px rgba(106, 17, 203, 0.2);
        }
        
        #itemNote {
            white-space: pre-wrap;
            word-break: break-word;
            line-height: 1.4;
            min-height: 80px;
            resize: vertical;
            font-family: inherit;
        }
        
        .form-select {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 1rem;
            background: white;
            cursor: pointer;
        }
        
        .path-type-selector {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .path-type-btn {
            flex: 1;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 8px;
            background: white;
            cursor: pointer;
            text-align: center;
            transition: all 0.2s;
        }
        
        .path-type-btn.active {
            background: #6a11cb;
            color: white;
            border-color: #6a11cb;
        }
        
        .path-example {
            font-size: 0.8rem;
            color: #666;
            margin-top: 5px;
        }
        
        .modal-footer {
            padding: 15px 25px;
            background: #f8f9fa;
            border-top: 1px solid #eaeaea;
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }
        
        .stats {
            padding: 15px 30px;
            background: #f8f9fa;
            border-top: 1px solid #eaeaea;
            display: flex;
            justify-content: space-between;
            font-size: 0.9rem;
            color: #666;
        }
        
        .permission-hint {
            padding: 10px 15px;
            background: #fff3cd;
            border-radius: 6px;
            margin: 10px 0;
            font-size: 0.9rem;
            color: #856404;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .loading-indicator {
            padding: 10px 15px;
            background: #d1ecf1;
            border-radius: 6px;
            margin: 10px 0;
            font-size: 0.9rem;
            color: #0c5460;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .error-message {
            padding: 10px 15px;
            background: #f8d7da;
            border-radius: 6px;
            margin: 10px 0;
            font-size: 0.9rem;
            color: #721c24;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .path-display {
            font-size: 0.8rem;
            color: #666;
            margin-top: 4px;
            word-break: break-all;
        }
        
        .header-edit-input {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border: 2px solid #6a11cb;
            background: white;
            padding: 0 15px;
            font-size: 0.95rem;
            font-weight: 600;
            outline: none;
        }
        
        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 12px 20px;
            border-radius: 6px;
            color: white;
            z-index: 10000;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            display: flex;
            align-items: center;
            gap: 10px;
            max-width: 400px;
            opacity: 0;
            transform: translateY(-20px);
            transition: all 0.3s ease;
        }
        
        .toast.show {
            opacity: 1;
            transform: translateY(0);
        }
        
        .toast-success {
            background: #28a745;
        }
        
        .toast-error {
            background: #dc3545;
        }
        
        .toast-info {
            background: #17a2b8;
        }
        
        .toast-warning {
            background: #ffc107;
            color: #212529;
        }
        
        /* 拖拽排序样式 */
        .draggable-row {
            cursor: move;
            transition: all 0.2s ease;
        }
        
        .draggable-row.dragging {
            background: #f0f7ff !important;
            box-shadow: 0 4px 12px rgba(106, 17, 203, 0.2);
            opacity: 0.8;
            border: 2px dashed #6a11cb;
        }
        
        .draggable-row.drag-over {
            border-top: 3px solid #2575fc;
        }
        
        .drag-handle {
            cursor: grab;
            color: #6c757d;
            padding: 0 8px;
            margin-right: 8px;
            transition: color 0.2s;
        }
        
        .drag-handle:hover {
            color: #6a11cb;
        }
        
        .drag-handle:active {
            cursor: grabbing;
        }
        
        .sort-controls {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-left: 10px;
        }
        
        /*.sort-btn {
            padding: 6px 12px;
            background: white;
            border: 1px solid #ddd;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.8rem;
            transition: all 0.2s;
        }*/
        .sort-btn {
            padding: 10px 18px;
            background: orange;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .sort-btn:hover {
            background: red;
            border-color: #6a11cb;
        }
        
        .sort-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        /* 响应式设计 */
        @media (max-width: 1200px) {
            .auth-main-row {
                gap: 20px;
            }
            
            .github-auth-side {
                min-width: 450px;
            }
            
            .token-input {
                width: 240px;
                min-width: 220px;
            }
        }

        @media (max-width: 992px) {
            .auth-main-row {
                flex-direction: column;
                align-items: stretch;
                gap: 15px;
            }
            
            .github-auth-side {
                min-width: auto;
                width: 100%;
            }
            
            .token-input-group {
                width: 100%;
            }
            
            .token-input {
                flex: 1;
                min-width: auto;
            }
        }
        
        @media (max-width: 768px) {
            .controls {
                flex-direction: column;
            }
            
            th, td {
                padding: 12px 15px;
            }
            
            h1 {
                font-size: 1.8rem;
            }
            
            .action-buttons {
                width: 100%;
                justify-content: space-between;
            }
            
            .btn {
                flex: 1;
                justify-content: center;
            }
            
            .stats {
                flex-direction: column;
                gap: 10px;
            }
            
            .auth-section {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .login-form {
                flex-direction: column;
                width: 100%;
            }
            
            .login-input {
                width: 100%;
            }
            
            .login-btn {
                width: 100%;
            }
            
            .github-auth-side {
                flex-direction: column;
                align-items: stretch;
            }
            
            .token-input-group {
                flex-direction: column;
            }
            
            .token-input {
                width: 100%;
            }
            
            .token-btn {
                width: 100%;
            }
            
            .token-hint {
                text-align: center;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>DH3项目HelpMe索引表</h1>
            <div class="admin-indicator" id="adminIndicator" style="display: none;">
                <i class="fas fa-user-shield"></i> 管理员模式
            </div>
        </header>
        
        <div class="auth-section">
            <div id="loginSection" style="display: block;">
                <div class="auth-main-row">
                    <!-- 登录表单 -->
                    <div class="login-form">
                        <input type="text" id="username" class="login-input" placeholder="用户名">
                        <input type="password" id="password" class="login-input" placeholder="密码">
                        <button class="login-btn" id="loginBtn">登录</button>
                    </div>
                    
                    <!-- GitHub令牌 - 右侧 -->
                    <div class="github-auth-side">
                        <div class="token-input-group">
                            <input type="password" id="githubToken" class="login-input token-input" placeholder="GitHub个人访问令牌">
                            <button class="login-btn token-btn" id="setupGitHubBtn">配置GitHub同步</button>
                        </div>
                        <div class="token-hint">
                            <small style="color: #28a745;">
                                <i class="fas fa-check-circle"></i> 完全免费 - 
                                <a href="javascript:void(0)" onclick="showGitHubTokenHelp()" style="color: #28a745;">令牌帮助</a>
                            </small>
                        </div>
                    </div>
                </div>
            </div>
            
            <div id="userSection" style="display: none;">
                <div class="user-info">
                    <span>欢迎, <strong id="userName">管理员</strong></span>
                    <span id="githubStatus" class="config-info" style="color: #28a745; margin-left: 10px;">
                        <i class="fas fa-check-circle"></i> GitHub已连接
                    </span>
                    <span class="config-info" id="configInfo"></span>
                    <button class="logout-btn" id="logoutBtn">退出登录</button>
                </div>
            </div>
        </div>
        
        <!-- 配置加载状态指示器 -->
        <div class="loading-indicator" id="loadingIndicator" style="display: none;">
            <i class="fas fa-sync fa-spin"></i>
            <span>正在从GitHub securityconfig加载配置...</span>
        </div>
        
        <div class="error-message" id="errorMessage" style="display: none;">
            <i class="fas fa-exclamation-triangle"></i>
            <span id="errorText">配置加载失败，使用备用数据</span>
        </div>
        
        <div class="controls">
            <div class="search-box">
                <span class="search-icon"><i class="fas fa-search"></i></span>
                <input type="text" id="searchInput" placeholder="搜索页面名称、分类或备注...">
            </div>
            
            <div class="filter-box">
                <button class="filter-btn active" data-category="all">全部</button>
                <!-- 分类按钮将通过JavaScript动态生成 -->
            </div>
            
            <div class="action-buttons">
                <button class="btn btn-primary" id="addBtn" style="display: none;">
                    <i class="fas fa-plus"></i> 添加新条目
                </button>
                
                <!-- 排序控制按钮 -->
                <div class="sort-controls" id="sortControls" style="display: none;">
                    <button class="sort-btn" id="enableSortBtn" title="启用拖拽排序">
                        <i class="fas fa-arrows-alt"></i> 调整顺序
                    </button>
                    <button class="sort-btn" id="saveOrderBtn" title="保存顺序" style="display: none;">
                        <i class="fas fa-save"></i> 保存顺序
                    </button>
                    <button class="sort-btn" id="cancelSortBtn" title="取消排序" style="display: none;">
                        <i class="fas fa-times"></i> 取消
                    </button>
                    <button class="sort-btn" id="resetOrderBtn" title="重置为默认顺序">
                        <i class="fas fa-undo"></i> 重置顺序
                    </button>
                </div>
                
                <button class="btn btn-success" id="exportBtn" style="display: none;">
                    <i class="fas fa-file-export"></i> 导出数据
                </button>
                <button class="btn btn-success" id="syncExcelBtn" style="display: none;">
                    <i class="fas fa-sync"></i> 同步到 Excel
                </button>
                <button class="btn btn-success" id="downloadExcelBtn">
                    <i class="fas fa-download"></i> 下载 Excel
                </button>
                <button class="btn btn-warning" id="repairExcelBtn" style="display: none;">
                    <i class="fas fa-tools"></i> 修复Excel格式
                </button>
                <button class="btn btn-success" id="updateHTMLBtn" style="display: none;">
                    <i class="fas fa-download"></i> 更新HTML
                </button>
                <button class="btn btn-danger" id="resetBtn" style="display: none;">
                    <i class="fas fa-redo"></i> 重置数据
                </button>
                <button class="btn btn-primary" id="refreshConfigBtn">
                    <i class="fas fa-sync-alt"></i> 刷新配置
                </button>
                <button class="btn btn-primary" id="editHeadersBtn" style="display: none;">
                    <i class="fas fa-edit"></i> 编辑表头
                </button>
            </div>
        </div>
        
        <div class="permission-hint" id="permissionHint" style="display: flex;">
            <i class="fas fa-info-circle"></i>
            <span>您当前是访客模式，只能查看数据。请登录管理员账户以进行添加、编辑和删除操作。</span>
        </div>
        
        <div class="table-container">
            <table>
                <thead>
                    <tr>
                        <th width="8%" class="editable-header" data-field="id">
                            <span id="header-id">序号</span>
                            <i class="fas fa-edit edit-icon"></i>
                        </th>
                        <th width="18%" class="editable-header" data-field="category">
                            <span id="header-category">分类</span>
                            <i class="fas fa-edit edit-icon"></i>
                        </th>
                        <th width="34%" class="editable-header" data-field="path">
                            <span id="header-path">链接地址</span>
                            <i class="fas fa-edit edit-icon"></i>
                        </th>
                        <th width="25%" class="editable-header" data-field="note">
                            <span id="header-note">备注</span>
                            <i class="fas fa-edit edit-icon"></i>
                        </th>
                        <th width="15%">操作</th>
                    </tr>
                </thead>
                <tbody id="tableBody">
                    <!-- 表格内容将通过JavaScript动态生成 -->
                </tbody>
            </table>
        </div>
        
        <div class="stats">
            <div id="totalCount">总计: 0 个项目</div>
            <div id="filteredCount">显示: 0 个项目</div>
            <div id="configVersion">配置版本: 加载中...</div>
        </div>
    </div>

    <!-- 添加/编辑模态框 -->
    <div class="modal" id="itemModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="modalTitle">添加新条目</h3>
                <button class="close-btn" id="closeModal">×</button>
            </div>
            <div class="modal-body">
                <form id="itemForm">
                    <input type="hidden" id="editId" value="">
                    <div class="form-group">
                        <label class="form-label" for="itemTitle">页面标题</label>
                        <input type="text" class="form-control" id="itemTitle" placeholder="输入页面标题" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="itemCategory">分类</label>
                        <select class="form-select" id="itemCategory" required>
                            <option value="">选择分类</option>
                            <!-- 分类选项将通过JavaScript动态生成 -->
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">路径类型</label>
                        <div class="path-type-selector">
                            <button type="button" class="path-type-btn active" data-type="url">网页URL</button>
                            <button type="button" class="path-type-btn" data-type="folder">文件夹路径</button>
                        </div>
                        <input type="text" class="form-control" id="itemPath" placeholder="输入网页URL地址" required>
                        <div class="path-example" id="pathExample">例如: https://example.com/page</div>
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="itemNote">备注</label>
                        <textarea class="form-control" id="itemNote" placeholder="输入备注信息" rows="3"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn cancel-btn" id="cancelBtn">取消</button>
                <button class="btn btn-primary" id="saveItemBtn">保存</button>
            </div>
        </div>
    </div>

    <!-- 表头编辑模态框 -->
    <div class="modal" id="headersModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">编辑表头名称</h3>
                <button class="close-btn" id="closeHeadersModal">×</button>
            </div>
            <div class="modal-body">
                <form id="headersForm">
                    <div class="form-group">
                        <label class="form-label" for="headerIdInput">序号列名称</label>
                        <input type="text" class="form-control" id="headerIdInput" placeholder="输入序号列名称">
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="headerCategoryInput">分类列名称</label>
                        <input type="text" class="form-control" id="headerCategoryInput" placeholder="输入分类列名称">
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="headerPathInput">链接地址列名称</label>
                        <input type="text" class="form-control" id="headerPathInput" placeholder="输入链接地址列名称">
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="headerNoteInput">备注列名称</label>
                        <input type="text" class="form-control" id="headerNoteInput" placeholder="输入备注列名称">
                    </div>
                </form>
                <div class="permission-hint">
                    <i class="fas fa-info-circle"></i>
                    <span>修改表头名称后，页面显示会立即更新，同时会保存到本地存储中。</span>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn cancel-btn" id="cancelHeadersBtn">取消</button>
                <button class="btn btn-primary" id="saveHeadersBtn">保存表头</button>
                <button class="btn btn-success" id="resetHeadersBtn">重置表头</button>
            </div>
        </div>
    </div>

    <!-- 引入SheetJS库用于处理Excel文件 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <!-- 引入默认数据文件 -->
    <script src="default-data.js"></script>

    <script>
        // 示例数据 - 将从GitHub配置加载
        let tableData = [];
        
        // GitHub配置URL
        const GITHUB_OWNER = 'Cybereign';
        const GITHUB_REPO = 'securityconfig';
        const GITHUB_BRANCH = 'main';
        const GITHUB_CONFIG_URL = `https://raw.githubusercontent.com/${GITHUB_OWNER}/${GITHUB_REPO}/${GITHUB_BRANCH}/config.json`;
        const GITHUB_EXCEL_URL = `https://raw.githubusercontent.com/${GITHUB_OWNER}/${GITHUB_REPO}/${GITHUB_BRANCH}/table.xlsx`;
        
        // GitHub API 端点
        const GITHUB_API_BASE = 'https://api.github.com';
        const GITHUB_CONTENT_URL = `${GITHUB_API_BASE}/repos/${GITHUB_OWNER}/${GITHUB_REPO}/contents`;
        
        // 用户账户信息和配置
        let adminAccounts = [];
        let appConfig = {};
        let categoryMap = {};
        let categoryList = [];

        // 表头配置
        let headerConfig = {
            id: '序号',
            category: '分类',
            path: '链接地址',
            note: '备注'
        };

        // 拖拽排序相关变量
        let isSortMode = false;
        let dragSrcEl = null;
        let originalOrder = [];

        // 修复的GitHub API 服务 - 处理SHA冲突问题
        class GitHubService {
            constructor(token) {
                this.token = token;
            }

            async getFileContent(filePath) {
                try {
                    const response = await fetch(`${GITHUB_CONTENT_URL}/${filePath}?ref=${GITHUB_BRANCH}`, {
                        headers: {
                            'Authorization': `token ${this.token}`,
                            'Accept': 'application/vnd.github.v3+json'
                        }
                    });

                    if (!response.ok) {
                        if (response.status === 404) {
                            // 文件不存在，返回null
                            return null;
                        }
                        throw new Error(`获取文件失败: ${response.status}`);
                    }

                    const data = await response.json();
                    const content = atob(data.content);
                    return {
                        content: content,
                        sha: data.sha,
                        exists: true
                    };
                } catch (error) {
                    console.error('获取文件内容失败:', error);
                    throw error;
                }
            }

            async updateFileContent(filePath, content, sha, commitMessage) {
                try {
                    const payload = {
                        message: commitMessage,
                        content: content,
                        branch: GITHUB_BRANCH
                    };

                    // 只有在文件已存在时才提供SHA
                    if (sha) {
                        payload.sha = sha;
                    }

                    const response = await fetch(`${GITHUB_CONTENT_URL}/${filePath}`, {
                        method: 'PUT',
                        headers: {
                            'Authorization': `token ${this.token}`,
                            'Accept': 'application/vnd.github.v3+json',
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        const errorData = await response.json();
                        
                        // 处理SHA不匹配错误
                        if (response.status === 409) {
                            throw new Error(`文件版本冲突。请先点击"修复Excel格式"按钮，然后重试。`);
                        }
                        
                        throw new Error(`更新文件失败: ${response.status} - ${errorData.message}`);
                    }

                    const data = await response.json();
                    console.log('文件更新成功:', data);
                    return data;
                } catch (error) {
                    console.error('更新文件失败:', error);
                    throw error;
                }
            }

            async checkAuth() {
                try {
                    const response = await fetch(`${GITHUB_API_BASE}/user`, {
                        headers: {
                            'Authorization': `token ${this.token}`,
                            'Accept': 'application/vnd.github.v3+json'
                        }
                    });

                    if (!response.ok) {
                        throw new Error('GitHub 认证失败');
                    }

                    const userData = await response.json();
                    return {
                        authenticated: true,
                        username: userData.login
                    };
                } catch (error) {
                    return {
                        authenticated: false,
                        error: error.message
                    };
                }
            }

            // 强制创建新文件（忽略SHA冲突）
            async forceCreateFile(filePath, content, commitMessage) {
                try {
                    // 先尝试获取当前文件信息
                    let currentFile = null;
                    try {
                        currentFile = await this.getFileContent(filePath);
                    } catch (error) {
                        console.log('文件不存在或获取失败，将创建新文件');
                    }

                    const payload = {
                        message: commitMessage,
                        content: content,
                        branch: GITHUB_BRANCH
                    };

                    // 如果文件存在，使用正确的SHA
                    if (currentFile && currentFile.exists) {
                        payload.sha = currentFile.sha;
                    }

                    const response = await fetch(`${GITHUB_CONTENT_URL}/${filePath}`, {
                        method: 'PUT',
                        headers: {
                            'Authorization': `token ${this.token}`,
                            'Accept': 'application/vnd.github.v3+json',
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        const errorData = await response.json();
                        
                        // 如果仍然冲突，尝试使用空SHA创建新文件
                        if (response.status === 409) {
                            console.log('文件冲突，尝试强制创建新文件...');
                            return await this.forceCreateNewFile(filePath, content, commitMessage);
                        }
                        
                        throw new Error(`强制创建文件失败: ${response.status} - ${errorData.message}`);
                    }

                    const data = await response.json();
                    console.log('文件强制创建成功:', data);
                    return data;
                } catch (error) {
                    console.error('强制创建文件失败:', error);
                    throw error;
                }
            }

            // 强制创建新文件（忽略现有文件）
            async forceCreateNewFile(filePath, content, commitMessage) {
                try {
                    // 直接创建新文件，不提供SHA
                    const payload = {
                        message: commitMessage,
                        content: content,
                        branch: GITHUB_BRANCH
                    };

                    const response = await fetch(`${GITHUB_CONTENT_URL}/${filePath}`, {
                        method: 'PUT',
                        headers: {
                            'Authorization': `token ${this.token}`,
                            'Accept': 'application/vnd.github.v3+json',
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(`创建新文件失败: ${response.status} - ${errorData.message}`);
                    }

                    const data = await response.json();
                    console.log('新文件创建成功:', data);
                    return data;
                } catch (error) {
                    console.error('创建新文件失败:', error);
                    throw error;
                }
            }
        }

        // 创建 GitHub 服务实例
        let gitHubService = null;

        // 自动登出和登录尝试
        let logoutTimer;
        let loginAttempts = 0;

        // 当前显示的数据和路径类型
        let currentData = [];
        let currentPathType = 'url';
        let isLoggedIn = false;
        let currentUser = null;

        // DOM元素
        const tableBody = document.getElementById('tableBody');
        const searchInput = document.getElementById('searchInput');
        const addBtn = document.getElementById('addBtn');
        const exportBtn = document.getElementById('exportBtn');
        const syncExcelBtn = document.getElementById('syncExcelBtn');
        const downloadExcelBtn = document.getElementById('downloadExcelBtn');
        const repairExcelBtn = document.getElementById('repairExcelBtn');
        const updateHTMLBtn = document.getElementById('updateHTMLBtn');
        const resetBtn = document.getElementById('resetBtn');
        const refreshConfigBtn = document.getElementById('refreshConfigBtn');
        const editHeadersBtn = document.getElementById('editHeadersBtn');
        const itemModal = document.getElementById('itemModal');
        const headersModal = document.getElementById('headersModal');
        const modalTitle = document.getElementById('modalTitle');
        const itemForm = document.getElementById('itemForm');
        const headersForm = document.getElementById('headersForm');
        const editId = document.getElementById('editId');
        const itemTitle = document.getElementById('itemTitle');
        const itemCategory = document.getElementById('itemCategory');
        const itemPath = document.getElementById('itemPath');
        const itemNote = document.getElementById('itemNote');
        const saveItemBtn = document.getElementById('saveItemBtn');
        const closeModal = document.getElementById('closeModal');
        const closeHeadersModal = document.getElementById('closeHeadersModal');
        const cancelBtn = document.getElementById('cancelBtn');
        const cancelHeadersBtn = document.getElementById('cancelHeadersBtn');
        const saveHeadersBtn = document.getElementById('saveHeadersBtn');
        const resetHeadersBtn = document.getElementById('resetHeadersBtn');
        const totalCount = document.getElementById('totalCount');
        const filteredCount = document.getElementById('filteredCount');
        const pathTypeButtons = document.querySelectorAll('.path-type-btn');
        const pathExample = document.getElementById('pathExample');
        const loginBtn = document.getElementById('loginBtn');
        const logoutBtn = document.getElementById('logoutBtn');
        const usernameInput = document.getElementById('username');
        const passwordInput = document.getElementById('password');
        const loginSection = document.getElementById('loginSection');
        const userSection = document.getElementById('userSection');
        const userName = document.getElementById('userName');
        const adminIndicator = document.getElementById('adminIndicator');
        const permissionHint = document.getElementById('permissionHint');
        const setupGitHubBtn = document.getElementById('setupGitHubBtn');
        const githubTokenInput = document.getElementById('githubToken');
        const enableSortBtn = document.getElementById('enableSortBtn');
        const saveOrderBtn = document.getElementById('saveOrderBtn');
        const cancelSortBtn = document.getElementById('cancelSortBtn');
        const resetOrderBtn = document.getElementById('resetOrderBtn');
        const sortControls = document.getElementById('sortControls');

        // ========== 核心功能函数 ==========

        // 检查默认数据是否加载成功
        function checkDefaultDataLoaded() {
            if (typeof DEFAULT_TABLE_DATA === 'undefined') {
                console.error('❌ 默认数据文件加载失败');
                showErrorMessage('默认数据文件加载失败，请检查 default-data.js 文件是否存在');
                return false;
            }
            console.log('✅ 默认数据文件加载成功（备用数据）');
            return true;
        }

        // 从外部文件加载默认数据
        function loadDefaultData() {
            try {
                // 检查外部数据文件是否成功加载
                if (typeof DEFAULT_TABLE_DATA === 'undefined') {
                    throw new Error('默认数据文件未加载，请检查 default-data.js 文件');
                }
                
                // 使用外部文件中的默认数据（深拷贝）
                tableData = JSON.parse(JSON.stringify(DEFAULT_TABLE_DATA));
                adminAccounts = JSON.parse(JSON.stringify(DEFAULT_ADMIN_ACCOUNTS));
                appConfig = JSON.parse(JSON.stringify(DEFAULT_APP_CONFIG));
                categoryList = JSON.parse(JSON.stringify(DEFAULT_CATEGORY_LIST));
                categoryMap = JSON.parse(JSON.stringify(DEFAULT_CATEGORY_MAP));
                
                console.log('✅ 从外部文件加载默认数据成功');
                return true;
                
            } catch (error) {
                console.error('❌ 加载默认数据失败:', error);
                showErrorMessage(`默认数据加载失败: ${error.message}`);
                return false;
            }
        }

        // 使用默认配置
        function useDefaultConfig() {
            try {
                loadDefaultData();
                
                // 确保ID顺序正确
                tableData.forEach((item, index) => {
                    item.id = index + 1;
                });
                
                updateConfigVersionInfo(appConfig);
                updateCategoryFilters();
                updateCategorySelect();
                renderTable(tableData);
                updateStats();
                
                if (isSortMode) {
                    exitSortMode();
                }
                
                return true;
            } catch (error) {
                console.error('使用默认配置失败:', error);
                showErrorMessage(`配置加载失败: ${error.message}`);
                return false;
            }
        }

        // 获取默认数据（用于重置功能）
        function getDefaultTableData() {
            if (typeof DEFAULT_TABLE_DATA === 'undefined') {
                throw new Error('默认数据文件未加载');
            }
            return JSON.parse(JSON.stringify(DEFAULT_TABLE_DATA));
        }

        // 从数据中初始化分类系统
        function initializeCategoriesFromData() {
            const uniqueCategories = new Map();
            tableData.forEach(item => {
                if (item.category && !uniqueCategories.has(item.category)) {
                    const categoryId = `category${uniqueCategories.size + 1}`;
                    uniqueCategories.set(item.category, {
                        id: categoryId,
                        name: item.category
                    });
                }
            });
            
            categoryList = Array.from(uniqueCategories.values());
            categoryList.forEach(category => {
                categoryMap[category.id] = category.name;
            });
            
            console.log('从数据中提取的分类:', categoryList);
            updateCategoryFilters();
        }

        // 修复的从GitHub加载配置函数
        async function loadConfigFromGitHub() {
            showLoadingIndicator('正在从GitHub securityconfig加载配置...');
            
            try {
                const [configResponse, excelResponse] = await Promise.all([
                    fetch(GITHUB_CONFIG_URL).catch(() => { throw new Error('无法连接到GitHub配置'); }),
                    fetch(GITHUB_EXCEL_URL).catch(() => { throw new Error('无法连接到Excel文件'); })
                ]);
                
                if (!configResponse.ok) throw new Error(`配置加载失败: HTTP ${configResponse.status}`);
                if (!excelResponse.ok) throw new Error(`Excel加载失败: HTTP ${excelResponse.status}`);
                
                const config = await configResponse.json();
                const arrayBuffer = await excelResponse.arrayBuffer();
                
                // 🎯 重要：处理Excel数据时会覆盖现有的tableData
                await processExcelData(arrayBuffer);
                adminAccounts = config.users || [];
                appConfig = config.settings || {};
                
                updateConfigVersionInfo(config);
                console.log('✅ GitHub securityconfig配置和Excel数据加载成功');
                
                // 更新分类系统
                if (categoryList.length === 0 && tableData.length > 0) {
                    initializeCategoriesFromData();
                }
                
        		return true;  // 🎯 明确返回成功
        
                
            } catch (error) {
                console.error('❌ GitHub配置加载失败:', error);
                showErrorMessage(`GitHub securityconfig配置加载失败: ${error.message}，使用备用数据`);
                return false;
            } finally {
                hideLoadingIndicator();
            }
        }

        // 处理Excel数据
        async function processExcelData(arrayBuffer) {
            try {
                const data = new Uint8Array(arrayBuffer);
                const workbook = XLSX.read(data, { 
                    type: 'array',
                    cellText: false,
                    cellDates: true,
                    raw: false
                });
                
                const firstSheetName = workbook.SheetNames[0];
                const worksheet = workbook.Sheets[firstSheetName];
                
                const excelData = XLSX.utils.sheet_to_json(worksheet, { 
                    header: 1,
                    defval: '',
                    blankrows: false
                });
                
                if (excelData.length < 2) {
                    throw new Error('Excel文件为空或格式不正确');
                }
                
                const headers = excelData[0];
                console.log('Excel表头结构:', headers);
                
                // 🎯 重要：清空现有数据，使用GitHub数据
                tableData = [];
                categoryMap = {};
                categoryList = [];
                const uniqueCategories = new Map();
                
                for (let i = 1; i < excelData.length; i++) {
                    const row = excelData[i];
                    if (row.length === 0 || !row.some(cell => cell !== '' && cell != null)) continue;
                    
                    const item = {
                        id: parseInt(row[0]) || i,
                        category: String(row[1] || '').trim(),
                        title: String(row[2] || '').trim(),
                        path: String(row[3] || '').trim(),
                        type: String(row[4] || 'url').toLowerCase().trim(),
                        note: String(row[5] || '').trim()
                    };
                    
                    if (!item.title && !item.path) continue;
                    
                    tableData.push(item);
                    
                    if (item.category && !uniqueCategories.has(item.category)) {
                        const categoryId = `category${uniqueCategories.size + 1}`;
                        uniqueCategories.set(item.category, {
                            id: categoryId,
                            name: item.category
                        });
                    }
                }
                
                categoryList = Array.from(uniqueCategories.values());
                categoryList.forEach(category => {
                    categoryMap[category.id] = category.name;
                });
                
                console.log('从GitHub securityconfig处理后的数据:', tableData);
                console.log('从GitHub securityconfig去重后的分类列表:', categoryList);
                
                updateCategoryFilters();
                renderTable(tableData);
                updateStats();
                
            } catch (error) {
                console.error('Excel数据处理失败:', error);
                throw new Error(`Excel文件处理失败: ${error.message}`);
            }
        }
	// 修复的初始化流程
document.addEventListener('DOMContentLoaded', async () => {
    // 首先检查默认数据是否加载成功（仅作为备用）
    checkDefaultDataLoaded();
    
    // 加载表头配置
    const savedHeaders = loadHeadersFromStorage();
    if (savedHeaders) {
        headerConfig = savedHeaders;
    }
    updateTableHeaders();

    // 加载保存的 GitHub 令牌
    loadGitHubToken();

    // 设置默认配置版本显示
    document.getElementById('configVersion').textContent = '配置版本: 加载中...';

    let githubDataLoaded = false;
    let dataSource = '';
    
    try {
        // 优先从GitHub加载配置
        console.log('🔄 正在从GitHub securityconfig加载数据...');
        githubDataLoaded = await loadConfigFromGitHub();
        
        if (githubDataLoaded) {
            console.log('✅ 成功从GitHub securityconfig加载数据');
            dataSource = 'GitHub SecurityConfig';
            appConfig.source = 'GitHub SecurityConfig';
        } else {
            console.log('❌ GitHub配置加载失败，尝试其他数据源');
        }
        
    } catch (error) {
        console.error('❌ GitHub配置加载异常:', error);
        githubDataLoaded = false;
    }
    
    // 🎯 修复：清晰的数据源选择逻辑
    const savedData = loadDataFromStorage();
    
    if (githubDataLoaded) {
        // 情况1: GitHub数据加载成功，使用GitHub数据
        console.log('✅ 使用GitHub securityconfig数据');
        dataSource = 'GitHub SecurityConfig';
        appConfig.source = 'GitHub SecurityConfig';
        
    } else if (savedData && savedData.length > 0) {
        // 情况2: GitHub加载失败，但有本地数据，使用本地数据
        console.log('🔄 GitHub加载失败，使用本地存储的数据');
        tableData = savedData;
        currentData = [...tableData];
        renderTable(currentData);
        updateStats();
        //appConfig.version = 'Temp';
        appConfig.source = 'Cache';
        //dataSource = '本地缓存';
        
        // 确保分类系统正确初始化
        if (categoryList.length === 0 && tableData.length > 0) {
            initializeCategoriesFromData();
        }
        
    } else {
        // 情况3: GitHub加载失败且没有本地数据，使用默认数据
        console.log('🔄 GitHub加载失败且无本地数据，使用默认数据');
        useDefaultConfig();
        appConfig.source = 'Builtin';
        //dataSource = '内置默认';
    }
    
    // 显示最终数据来源信息
    console.log(`🎯 最终数据来源: ${dataSource}`);
    console.log(`📊 数据量: ${tableData.length} 条记录`);
    
    setupEventListeners();
    checkLoginStatus();
    updateCategorySelect();
    updateConfigVersionInfo(appConfig);
    updateButtonVisibility();
    
    // 设置用户活动监听器
    document.addEventListener('click', resetAutoLogoutTimer);
    document.addEventListener('keypress', resetAutoLogoutTimer);
    document.addEventListener('mousemove', resetAutoLogoutTimer);
    
    // 初始化排序功能
    initSorting();
    
    // 显示初始化完成状态
    showToast(`系统初始化完成，数据来源: ${dataSource}`, 'success');
});
		
       /* // 修复的初始化流程
        document.addEventListener('DOMContentLoaded', async () => {
            // 首先检查默认数据是否加载成功（仅作为备用）
            checkDefaultDataLoaded();
            
            // 加载表头配置
            const savedHeaders = loadHeadersFromStorage();
            if (savedHeaders) {
                headerConfig = savedHeaders;
            }
            updateTableHeaders();

            // 加载保存的 GitHub 令牌
            loadGitHubToken();

            // 设置默认配置版本显示
            document.getElementById('configVersion').textContent = '配置版本: 加载中...';

            let githubDataLoaded = false;
            
            try {
                // 优先从GitHub加载配置
                console.log('正在从GitHub securityconfig加载数据...');
                await loadConfigFromGitHub();
                githubDataLoaded = true;
                console.log('✅ 成功从GitHub securityconfig加载数据');
                
            } catch (error) {
                console.error('❌ GitHub配置加载失败:', error);
                showErrorMessage(`GitHub配置加载失败: ${error.message}，使用备用数据`);
                githubDataLoaded = false;
            }
            
            // 🎯 修复：只有在GitHub加载失败且没有本地数据时，才使用默认数据
            const savedData = loadDataFromStorage();
            
            if (githubDataLoaded) {
                // GitHub数据加载成功，使用GitHub数据
                console.log('使用GitHub securityconfig数据');
                appConfig.source = 'GitHub';
                
            } else if (savedData && savedData.length > 0) {
                // GitHub加载失败，但有本地数据，使用本地数据
                console.log('使用本地存储的数据');
                tableData = savedData;
                currentData = [...tableData];
                renderTable(currentData);
                updateStats();
				appConfig.version='Temp';
                appConfig.source = 'Cache';
                
                // 确保分类系统正确初始化
                if (categoryList.length === 0 && tableData.length > 0) {
                    initializeCategoriesFromData();
                }
                
            } else {
                // GitHub加载失败且没有本地数据，使用默认数据
                console.log('使用默认数据');
                useDefaultConfig();
                //appConfig.version = 'Default';
				//appConfig.source = 'Builtin';
            }
            
            setupEventListeners();
            checkLoginStatus();
            updateCategorySelect();
            updateConfigVersionInfo(appConfig);
            updateButtonVisibility();
            
            // 设置用户活动监听器
            document.addEventListener('click', resetAutoLogoutTimer);
            document.addEventListener('keypress', resetAutoLogoutTimer);
            document.addEventListener('mousemove', resetAutoLogoutTimer);
            
            // 初始化排序功能
            initSorting();
        });*/

        // 优化后的 openFolder 函数
        function openFolder(path) {
            const decodedPath = path.replace(/\\\\/g, '\\');
            
            // 智能环境检测
            if (isLocalEnvironment()) {
                // 本地环境：尝试直接打开
                return attemptDirectOpen(path);
            } else {
                // 网络环境：使用复制方案
                return offerPathCopy(path, '由于网页安全限制，无法直接打开本地文件夹。');
            }
        }

        // 检测是否为本地环境
        function isLocalEnvironment() {
            const protocol = window.location.protocol;
            const hostname = window.location.hostname;
            
            // 本地文件协议
            if (protocol === 'file:') {
                return true;
            }
            
            // localhost 或本地 IP
            if (hostname === 'localhost' || hostname === '127.0.0.1' || hostname === '::1') {
                return true;
            }
            
            // 本地网络 IP (192.168.x.x, 10.x.x.x, 172.16.x.x - 172.31.x.x)
            if (/^(192\.168|10|172\.(1[6-9]|2[0-9]|3[0-1]))\./.test(hostname)) {
                return true;
            }
            
            return false;
        }

        // 尝试直接打开文件夹
        function attemptDirectOpen(decodedPath) {
            const fileUrl = `file:///${decodedPath.replace(/\\/g, '/')}`;
            
            // 方法1: 使用 window.open
            try {
                const newWindow = window.open(fileUrl, '_blank');
                
                // 检查是否打开成功（某些浏览器会返回 null 如果被阻止）
                if (newWindow === null || newWindow.closed) {
                    throw new Error('窗口打开被阻止');
                }
                
                showToast('正在打开文件夹...', 'info');
                return true;
            } catch (error) {
                console.log('方法1失败:', error.message);
            }
            
            // 方法2: 使用 a 标签点击
            try {
                const link = document.createElement('a');
                link.href = fileUrl;
                link.target = '_blank';
                link.style.display = 'none';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                showToast('正在尝试打开文件夹...', 'info');
                
                // 延迟检查是否真的打开了
                setTimeout(() => {
                    // 如果仍然需要复制功能，可以在这里提供
                    offerPathCopy(decodedPath, '如果文件夹没有打开，请使用复制功能：');
                }, 1000);
                
                return true;
            } catch (error) {
                console.log('方法2失败:', error.message);
            }
            
            // 所有方法都失败，降级到复制方案
            console.log('所有直接打开方法都失败，使用复制方案');
            offerPathCopy(decodedPath, '直接打开失败，请使用复制功能：');
            return false;
        }

        // 提供路径复制功能
        function offerPathCopy(decodedPath, reason = '') {
            const message = reason + '\n\n是否将以下路径复制到剪贴板？\n\n路径: ' + decodedPath;
            
            if (confirm(message)) {
                copyToClipboard(decodedPath).then(() => {
                    showToast('✅ 路径已复制到剪贴板！', 'success');
                }).catch(err => {
                    // 备用复制方案
                    fallbackCopy(decodedPath);
                });
            }
            return false;
        }

        // 复制到剪贴板
        async function copyToClipboard(text) {
            if (navigator.clipboard && window.isSecureContext) {
                await navigator.clipboard.writeText(text);
                return true;
            } else {
                // 降级方案
                return fallbackCopy(text);
            }
        }

        // 备用复制方法
        function fallbackCopy(text) {
            return new Promise((resolve, reject) => {
                try {
                    const textArea = document.createElement('textarea');
                    textArea.value = text;
                    textArea.style.position = 'fixed';
                    textArea.style.opacity = '0';
                    textArea.style.left = '-9999px';
                    document.body.appendChild(textArea);
                    textArea.select();
                    textArea.setSelectionRange(0, 99999); // 移动设备支持
                    
                    const successful = document.execCommand('copy');
                    document.body.removeChild(textArea);
                    
                    if (successful) {
                        resolve(true);
                    } else {
                        reject(new Error('复制命令失败'));
                    }
                } catch (err) {
                    reject(err);
                }
            });
        }

        // 显示 Toast 消息
        function showToast(message, type = 'info') {
            // 移除现有的 toast
            const existingToast = document.querySelector('.toast');
            if (existingToast) {
                existingToast.remove();
            }
            
            const toast = document.createElement('div');
            toast.className = `toast toast-${type}`;
            toast.innerHTML = `
                <i class="fas ${getToastIcon(type)}"></i>
                <span>${message}</span>
            `;
            
            document.body.appendChild(toast);
            
            // 添加动画
            setTimeout(() => toast.classList.add('show'), 10);
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => {
                    if (toast.parentNode) toast.remove();
                }, 300);
            }, 3000);
        }

        function getToastIcon(type) {
            const icons = {
                success: 'fa-check-circle',
                error: 'fa-times-circle',
                warning: 'fa-exclamation-triangle',
                info: 'fa-info-circle'
            };
            return icons[type] || 'fa-info-circle';
        }

        // SHA-256哈希函数
        async function sha256(message) {
            const msgString = String(message);
            const encoder = new TextEncoder();
            const data = encoder.encode(msgString);
            const hashBuffer = await crypto.subtle.digest('SHA-256', data);
            const hashArray = Array.from(new Uint8Array(hashBuffer));
            const hashHex = hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
            return hashHex;
        }

        // 创建分类颜色映射函数
        function createCategoryColorMap() {
            const colorMap = {};
            const uniqueCategories = [...new Set(tableData.map(item => item.category).filter(Boolean))];
            
            uniqueCategories.forEach((category, index) => {
                // 使用索引而不是字符码，确保相同分类相同颜色
                const colorIndex = (index % 10) + 1; // 1-10
                colorMap[category] = `category-${colorIndex}`;
            });
            
            return colorMap;
        }

        // 渲染表格 - 修复版本（相同分类相同颜色）
        function renderTable(data) {
            if (data.length === 0) {
                tableBody.innerHTML = `<tr><td colspan="5" class="empty-row">未找到匹配的页面</td></tr>`;
                return;
            }
            
            // 创建分类颜色映射
            const categoryColorMap = createCategoryColorMap();
            
            tableBody.innerHTML = data.map(item => {
                const isUrl = item.type === 'url';
                const linkClass = isUrl ? 'link' : 'link folder-link';
                const iconClass = isUrl ? 'fas fa-external-link-alt' : 'fas fa-folder-open';
                const badgeClass = isUrl ? 'badge-url' : 'badge-folder';
                const badgeText = isUrl ? '网页' : '文件夹';
                const categoryName = item.category || `分类${item.id}`;
                
                // 修复：使用分类名称计算颜色，确保相同分类颜色一致
                const categoryClass = categoryColorMap[categoryName] || 'category-1';
                
                if (isUrl) {
                    return `
                    <tr>
                        <td>${item.id}</td>
                        <td><span class="category ${categoryClass}">${categoryName}</span></td>
                        <td>
                            <a href="${item.path}" target="_blank" class="${linkClass}">
                                <i class="${iconClass} link-icon"></i> 
                                ${item.title}
                                <span class="path-type-badge ${badgeClass}">${badgeText}</span>
                            </a>
                            <div class="path-display">${item.path}</div>
                        </td>
                        <td class="note">${item.note}</td>
                        <td class="action-cell">
                            <button class="action-btn edit-btn" data-id="${item.id}" ${isLoggedIn ? '' : 'disabled'}>
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="action-btn delete-btn" data-id="${item.id}" ${isLoggedIn ? '' : 'disabled'}>
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    </tr>
                    `;
                } else {
                    return `
                    <tr>
                        <td>${item.id}</td>
                        <td><span class="category ${categoryClass}">${categoryName}</span></td>
                        <td>
                            <a href="#" class="${linkClass}" onclick="return openFolder('${item.path.replace(/\\/g, '\\\\')}')">
                                <i class="${iconClass} link-icon"></i> 
                                ${item.title}
                                <span class="path-type-badge ${badgeClass}">${badgeText}</span>
                            </a>
                            <div class="path-display">${item.path}</div>
                        </td>
                        <td class="note">${item.note}</td>
                        <td class="action-cell">
                            <button class="action-btn edit-btn" data-id="${item.id}" ${isLoggedIn ? '' : 'disabled'}>
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="action-btn delete-btn" data-id="${item.id}" ${isLoggedIn ? '' : 'disabled'}>
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    </tr>
                    `;
                }
            }).join('');
            
            // 如果处于排序模式，重新启用拖拽功能
            if (isSortMode) {
                makeRowsDraggable();
            }
            
            document.querySelectorAll('.edit-btn').forEach(btn => {
                if (!btn.disabled) {
                    btn.addEventListener('click', (e) => {
                        const id = parseInt(e.currentTarget.dataset.id);
                        openModal(id);
                    });
                }
            });
            
            document.querySelectorAll('.delete-btn').forEach(btn => {
                if (!btn.disabled) {
                    btn.addEventListener('click', (e) => {
                        const id = parseInt(e.currentTarget.dataset.id);
                        deleteItem(id);
                    });
                }
            });
            
            updateStats();
        }

        // ========== 拖拽排序功能 ==========

        // 初始化排序功能
        function initSorting() {
            // 显示排序控制区域（仅管理员）
            if (isLoggedIn && currentUser && currentUser.permissions.includes('write')) {
                sortControls.style.display = 'flex';
            }

            // 启用排序模式
            enableSortBtn.addEventListener('click', enableSortMode);

            // 保存顺序
            saveOrderBtn.addEventListener('click', saveNewOrder);

            // 取消排序
            cancelSortBtn.addEventListener('click', cancelSortMode);

            // 重置顺序
            resetOrderBtn.addEventListener('click', resetToDefaultOrder);
        }

        // 启用排序模式
        function enableSortMode() {
            if (!isLoggedIn) {
                alert('请先登录管理员账户');
                return;
            }

            isSortMode = true;
            originalOrder = [...tableData]; // 保存原始顺序
            
            // 更新按钮状态
            enableSortBtn.style.display = 'none';
            saveOrderBtn.style.display = 'inline-block';
            cancelSortBtn.style.display = 'inline-block';
            
            // 添加拖拽样式和功能
            makeRowsDraggable();
            
            showToast('拖拽排序模式已启用，拖动行可以调整顺序', 'info');
        }

        // 使行可拖拽
        function makeRowsDraggable() {
            const rows = tableBody.querySelectorAll('tr');
            
            rows.forEach(row => {
                // 添加拖拽类名
                row.classList.add('draggable-row');
                
                // 添加拖拽手柄到序号单元格
                const idCell = row.cells[0];
                if (!idCell.querySelector('.drag-handle')) {
                    const dragHandle = document.createElement('span');
                    dragHandle.className = 'drag-handle';
                    dragHandle.innerHTML = '<i class="fas fa-arrows-alt"></i>';
                    idCell.insertBefore(dragHandle, idCell.firstChild);
                }
                
                // 设置拖拽属性
                row.setAttribute('draggable', 'true');
                
                // 移除原有的事件监听器（避免重复绑定）
                row.removeEventListener('dragstart', handleDragStart);
                row.removeEventListener('dragover', handleDragOver);
                row.removeEventListener('dragenter', handleDragEnter);
                row.removeEventListener('dragleave', handleDragLeave);
                row.removeEventListener('drop', handleDrop);
                row.removeEventListener('dragend', handleDragEnd);
                
                // 添加拖拽事件
                row.addEventListener('dragstart', handleDragStart);
                row.addEventListener('dragover', handleDragOver);
                row.addEventListener('dragenter', handleDragEnter);
                row.addEventListener('dragleave', handleDragLeave);
                row.addEventListener('drop', handleDrop);
                row.addEventListener('dragend', handleDragEnd);
            });
        }

        // 拖拽事件处理函数
        function handleDragStart(e) {
            if (!isSortMode) {
                e.preventDefault();
                return;
            }
            
            this.classList.add('dragging');
            dragSrcEl = this;
            e.dataTransfer.effectAllowed = 'move';
            e.dataTransfer.setData('text/html', this.innerHTML);
        }

        function handleDragOver(e) {
            if (!isSortMode) return;
            
            e.preventDefault();
            e.dataTransfer.dropEffect = 'move';
            return false;
        }

        function handleDragEnter(e) {
            if (!isSortMode) return;
            
            this.classList.add('drag-over');
        }

        function handleDragLeave(e) {
            if (!isSortMode) return;
            
            this.classList.remove('drag-over');
        }

        function handleDrop(e) {
            if (!isSortMode) return;
            
            e.stopPropagation();
            e.preventDefault();
            
            if (dragSrcEl !== this) {
                // 移动行
                const allRows = Array.from(tableBody.querySelectorAll('tr'));
                const srcIndex = allRows.indexOf(dragSrcEl);
                const destIndex = allRows.indexOf(this);
                
                if (srcIndex < destIndex) {
                    tableBody.insertBefore(dragSrcEl, this.nextSibling);
                } else {
                    tableBody.insertBefore(dragSrcEl, this);
                }
                
                // 更新视觉顺序
                updateRowNumbers();
            }
            
            this.classList.remove('drag-over');
            return false;
        }

        function handleDragEnd(e) {
            if (!isSortMode) return;
            
            const rows = tableBody.querySelectorAll('tr');
            rows.forEach(row => {
                row.classList.remove('dragging');
                row.classList.remove('drag-over');
            });
        }

        // 更新行号显示
        function updateRowNumbers() {
            const rows = tableBody.querySelectorAll('tr');
            rows.forEach((row, index) => {
                const idCell = row.cells[0];
                const dragHandle = idCell.querySelector('.drag-handle');
                idCell.innerHTML = '';
                if (dragHandle) {
                    idCell.appendChild(dragHandle);
                }
                idCell.appendChild(document.createTextNode(index + 1));
            });
        }

        // 保存新顺序
        function saveNewOrder() {
            if (!isSortMode) return;
            
            // 获取新的顺序
            const rows = tableBody.querySelectorAll('tr');
            const newOrder = [];
            
            rows.forEach(row => {
                const id = parseInt(row.querySelector('.edit-btn').dataset.id);
                const item = tableData.find(item => item.id === id);
                if (item) {
                    newOrder.push(item);
                }
            });
            
            // 更新数据
            tableData = newOrder;
            
            // 重新生成ID顺序
            tableData.forEach((item, index) => {
                item.id = index + 1;
            });
            
            // 保存到本地存储
            saveDataToStorage();
            
            // 退出排序模式
            exitSortMode();
            
            showToast('顺序已保存！', 'success');
        }

        // 取消排序模式
        function cancelSortMode() {
            if (!isSortMode) return;
            
            // 恢复原始顺序
            tableData = originalOrder;
            
            // 重新渲染表格
            const searchTerm = searchInput.value.toLowerCase();
            const activeCategory = document.querySelector('.filter-btn.active')?.dataset.category || 'all';
            filterTable(searchTerm, activeCategory);
            
            exitSortMode();
            showToast('顺序调整已取消', 'info');
        }

        // 退出排序模式
        function exitSortMode() {
            isSortMode = false;
            dragSrcEl = null;
            originalOrder = [];
            
            // 更新按钮状态
            enableSortBtn.style.display = 'inline-block';
            saveOrderBtn.style.display = 'none';
            cancelSortBtn.style.display = 'none';
            
            // 移除拖拽样式
            const rows = tableBody.querySelectorAll('tr');
            rows.forEach(row => {
                row.classList.remove('draggable-row');
                row.setAttribute('draggable', 'false');
                
                // 移除拖拽手柄
                const dragHandle = row.querySelector('.drag-handle');
                if (dragHandle) {
                    dragHandle.remove();
                }
            });
        }

        // 重置为默认顺序
        function resetToDefaultOrder() {
            if (!isLoggedIn) {
                alert('请先登录管理员账户');
                return;
            }
            
            if (!confirm('确定要重置为默认顺序吗？这将丢失所有自定义排序。')) {
                return;
            }
            
            // 重新加载默认配置
            useDefaultConfig();
            
            showToast('已重置为默认顺序', 'success');
        }

        // ========== 数据管理函数 ==========

        // 数据持久化函数
        function saveDataToStorage() {
            localStorage.setItem('h5IndexData', JSON.stringify(tableData));
        }

        function loadDataFromStorage() {
            const savedData = localStorage.getItem('h5IndexData');
            if (savedData) {
                return JSON.parse(savedData);
            }
            return null;
        }

        // 表头配置持久化
        function saveHeadersToStorage() {
            localStorage.setItem('h5IndexHeaders', JSON.stringify(headerConfig));
        }

        function loadHeadersFromStorage() {
            const savedHeaders = localStorage.getItem('h5IndexHeaders');
            if (savedHeaders) {
                return JSON.parse(savedHeaders);
            }
            return null;
        }

        // 设置自动登出
        function setupAutoLogout() {
            if (logoutTimer) {
                clearTimeout(logoutTimer);
            }
            
            const autoLogoutMinutes = appConfig.autoLogout || 60;
            
            logoutTimer = setTimeout(() => {
                if (isLoggedIn) {
                    alert(`由于长时间未操作，系统已自动登出。自动登出时间：${autoLogoutMinutes}分钟`);
                    handleLogout();
                }
            }, autoLogoutMinutes * 60 * 1000);
        }

        // 重置自动登出计时器
        function resetAutoLogoutTimer() {
            if (isLoggedIn) {
                setupAutoLogout();
            }
        }

        // 更新表格表头显示
        function updateTableHeaders() {
            document.getElementById('header-id').textContent = headerConfig.id;
            document.getElementById('header-category').textContent = headerConfig.category;
            document.getElementById('header-path').textContent = headerConfig.path;
            document.getElementById('header-note').textContent = headerConfig.note;

            searchInput.placeholder = `搜索页面名称、${headerConfig.category.toLowerCase()}或${headerConfig.note.toLowerCase()}...`;
        }

        // 检查登录状态
        function checkLoginStatus() {
            const savedUser = localStorage.getItem('h5IndexCurrentUser');
            if (savedUser) {
                const user = JSON.parse(savedUser);
                loginSuccess(user);
            }
        }

        // 设置事件监听器
        function setupEventListeners() {
            // 搜索功能
            searchInput.addEventListener('input', handleSearch);
            
            // 路径类型选择
            pathTypeButtons.forEach(btn => {
                btn.addEventListener('click', handlePathTypeChange);
            });
            
            // 添加新条目
            addBtn.addEventListener('click', () => openModal());
            
            // 导出数据
            exportBtn.addEventListener('click', exportData);
            
            // 同步到 Excel
            syncExcelBtn.addEventListener('click', syncDataToExcel);
            
            // 下载 Excel
            downloadExcelBtn.addEventListener('click', downloadExcel);
            
            // 修复Excel格式
            repairExcelBtn.addEventListener('click', repairExcelFormat);
            
            // 更新HTML
            updateHTMLBtn.addEventListener('click', downloadUpdatedHTML);
            
            // 重置数据
            resetBtn.addEventListener('click', resetData);
            
            // 刷新配置
            refreshConfigBtn.addEventListener('click', refreshConfig);
            
            // 编辑表头
            editHeadersBtn.addEventListener('click', openHeadersModal);
            
            // GitHub 配置
            setupGitHubBtn.addEventListener('click', setupGitHubSync);
            
            // 模态框控制
            closeModal.addEventListener('click', closeModalFunc);
            closeHeadersModal.addEventListener('click', closeHeadersModalFunc);
            cancelBtn.addEventListener('click', closeModalFunc);
            cancelHeadersBtn.addEventListener('click', closeHeadersModalFunc);
            saveItemBtn.addEventListener('click', saveItem);
            saveHeadersBtn.addEventListener('click', saveHeaders);
            resetHeadersBtn.addEventListener('click', resetHeaders);
            
            // 登录/登出
            loginBtn.addEventListener('click', handleLogin);
            logoutBtn.addEventListener('click', handleLogout);
            
            // 点击模态框外部关闭
            window.addEventListener('click', (e) => {
                if (e.target === itemModal) {
                    closeModalFunc();
                }
                if (e.target === headersModal) {
                    closeHeadersModalFunc();
                }
            });
            
            // 回车登录
            passwordInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    handleLogin();
                }
            });

            // 表头点击编辑
            setupHeaderEditListeners();
            
            // 筛选事件
            setupFilterEvents();
        }

        // 设置表头编辑事件
        function setupHeaderEditListeners() {
            const editableHeaders = document.querySelectorAll('.editable-header');
            editableHeaders.forEach(header => {
                header.addEventListener('click', (e) => {
                    if (isLoggedIn && currentUser && currentUser.permissions.includes('config')) {
                        editHeader(e.currentTarget);
                    }
                });
            });
        }

        // 编辑单个表头
        function editHeader(headerElement) {
            const field = headerElement.dataset.field;
            const currentText = headerElement.querySelector('span').textContent;
            
            const input = document.createElement('input');
            input.type = 'text';
            input.className = 'header-edit-input';
            input.value = currentText;
            
            headerElement.style.position = 'relative';
            headerElement.appendChild(input);
            input.focus();
            input.select();
            
            const saveEdit = () => {
                const newValue = input.value.trim();
                if (newValue && newValue !== currentText) {
                    headerConfig[field] = newValue;
                    saveHeadersToStorage();
                    updateTableHeaders();
                }
                headerElement.removeChild(input);
            };
            
            input.addEventListener('blur', saveEdit);
            input.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    saveEdit();
                }
                if (e.key === 'Escape') {
                    headerElement.removeChild(input);
                }
            });
        }

        // 设置筛选事件
        function setupFilterEvents() {
            const filterButtons = document.querySelectorAll('.filter-btn');
            filterButtons.forEach(btn => {
                btn.addEventListener('click', handleFilter);
            });
        }

        // 处理路径类型变化
        function handlePathTypeChange(e) {
            pathTypeButtons.forEach(btn => btn.classList.remove('active'));
            e.currentTarget.classList.add('active');
            currentPathType = e.currentTarget.dataset.type;
            
            if (currentPathType === 'url') {
                pathExample.textContent = '例如: https://example.com/page';
                itemPath.placeholder = '输入网页URL地址';
            } else {
                pathExample.textContent = '例如: \\\\10.4.9.25\\Project\\文件夹 或 D:\\Projects\\文件夹';
                itemPath.placeholder = '输入文件夹路径';
            }
        }

        // 处理搜索
        function handleSearch() {
            const searchTerm = searchInput.value.toLowerCase();
            const activeCategory = document.querySelector('.filter-btn.active')?.dataset.category || 'all';
            filterTable(searchTerm, activeCategory);
        }

        // 处理筛选
        function handleFilter(e) {
            const filterButtons = document.querySelectorAll('.filter-btn');
            filterButtons.forEach(btn => btn.classList.remove('active'));
            e.currentTarget.classList.add('active');
            
            const searchTerm = searchInput.value.toLowerCase();
            const category = e.currentTarget.dataset.category;
            filterTable(searchTerm, category);
        }

        // 筛选表格数据
        function filterTable(searchTerm, category) {
            let filteredData = tableData;
            
            if (searchTerm) {
                filteredData = filteredData.filter(item => 
                    item.title.toLowerCase().includes(searchTerm) || 
                    (item.category || '').toLowerCase().includes(searchTerm) ||
                    item.note.toLowerCase().includes(searchTerm) ||
                    item.path.toLowerCase().includes(searchTerm)
                );
            }
            
            if (category !== 'all') {
                const selectedCategory = categoryList.find(cat => cat.id === category);
                if (selectedCategory) {
                    filteredData = filteredData.filter(item => item.category === selectedCategory.name);
                }
            }
            
            currentData = filteredData;
            renderTable(currentData);
            updateStats();
        }

        // 打开模态框
        function openModal(id = null) {
            if (!isLoggedIn) {
                alert('请先登录管理员账户');
                return;
            }
            
            if (id) {
                const item = tableData.find(item => item.id === id);
                if (item) {
                    modalTitle.textContent = '编辑条目';
                    editId.value = item.id;
                    itemTitle.value = item.title;
                    const categoryEntry = Object.entries(categoryMap).find(([id, name]) => name === item.category);
                    itemCategory.value = categoryEntry ? categoryEntry[0] : '';
                    itemPath.value = item.path;
                    itemNote.value = item.note;
                    
                    currentPathType = item.type;
                    pathTypeButtons.forEach(btn => {
                        btn.classList.toggle('active', btn.dataset.type === item.type);
                    });
                    updatePathExample();
                }
            } else {
                modalTitle.textContent = '添加新条目';
                itemForm.reset();
                editId.value = '';
                
                currentPathType = 'url';
                pathTypeButtons.forEach(btn => {
                    btn.classList.toggle('active', btn.dataset.type === 'url');
                });
                updatePathExample();
            }
            
            itemModal.style.display = 'flex';
        }

        // 更新路径示例
        function updatePathExample() {
            if (currentPathType === 'url') {
                pathExample.textContent = '例如: https://example.com/page';
                itemPath.placeholder = '输入网页URL地址';
            } else {
                pathExample.textContent = '例如: \\\\10.4.9.25\\Project\\文件夹 或 D:\\Projects\\文件夹';
                itemPath.placeholder = '输入文件夹路径';
            }
        }

        // 关闭模态框
        function closeModalFunc() {
            itemModal.style.display = 'none';
            itemForm.reset();
        }

        // 保存条目
        function saveItem() {
            if (!isLoggedIn) {
                alert('请先登录管理员账户');
                return;
            }
            
            if (!itemTitle.value.trim() || !itemCategory.value || !itemPath.value.trim()) {
                alert('请填写所有必填字段！');
                return;
            }
            
            const pathValue = itemPath.value.trim();
            let detectedType = currentPathType;
            
            if (pathValue.startsWith('http://') || pathValue.startsWith('https://')) {
                detectedType = 'url';
            } else if (pathValue.includes('\\\\') || pathValue.includes(':\\')) {
                detectedType = 'folder';
            }
            
            const id = editId.value ? parseInt(editId.value) : generateId();
            
            // 正确处理新分类
            let categoryName;
            let categoryId = itemCategory.value;
            
            // 检查是否是现有分类
            const existingCategory = categoryList.find(cat => cat.id === categoryId);
            if (existingCategory) {
                categoryName = existingCategory.name;
            } else {
                // 这是新分类，需要创建
                categoryName = categoryId; // 用户输入的分类名称
                categoryId = `category${categoryList.length + 1}`;
                
                // 添加到分类列表
                const newCategory = {
                    id: categoryId,
                    name: categoryName
                };
                categoryList.push(newCategory);
                categoryMap[categoryId] = categoryName;
                
                // 更新分类筛选器和下拉框
                updateCategoryFilters();
                updateCategorySelect();
                
                console.log('✅ 新分类已添加:', newCategory);
            }
            
            const newItem = {
                id: id,
                category: categoryName,
                title: itemTitle.value.trim(),
                path: pathValue,
                type: detectedType,
                note: itemNote.value.trim()
            };
            
            if (editId.value) {
                const index = tableData.findIndex(item => item.id === id);
                if (index !== -1) {
                    tableData[index] = newItem;
                }
            } else {
                tableData.push(newItem);
            }
            
            saveDataToStorage();
            
            const searchTerm = searchInput.value.toLowerCase();
            const activeCategory = document.querySelector('.filter-btn.active')?.dataset.category || 'all';
            filterTable(searchTerm, activeCategory);
            
            closeModalFunc();
            showToast('条目保存成功！', 'success');
        }

        // 生成新ID
        function generateId() {
            return tableData.length > 0 ? Math.max(...tableData.map(item => item.id)) + 1 : 1;
        }

        // 删除条目
        function deleteItem(id) {
            if (!isLoggedIn) {
                alert('请先登录管理员账户');
                return;
            }
            
            if (confirm('确定要删除这个条目吗？')) {
                tableData = tableData.filter(item => item.id !== id);
                saveDataToStorage();
                
                const searchTerm = searchInput.value.toLowerCase();
                const activeCategory = document.querySelector('.filter-btn.active')?.dataset.category || 'all';
                filterTable(searchTerm, activeCategory);
                
                showToast('条目删除成功！', 'success');
            }
        }

        // 导出数据
        function exportData() {
            const dataStr = JSON.stringify(tableData, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            
            const link = document.createElement('a');
            link.href = URL.createObjectURL(dataBlob);
            link.download = 'h5-index-data.json';
            link.click();
            
            showToast('数据导出成功！', 'success');
        }

        // 打开表头编辑模态框
        function openHeadersModal() {
            if (!isLoggedIn) {
                alert('请先登录管理员账户');
                return;
            }
            
            document.getElementById('headerIdInput').value = headerConfig.id;
            document.getElementById('headerCategoryInput').value = headerConfig.category;
            document.getElementById('headerPathInput').value = headerConfig.path;
            document.getElementById('headerNoteInput').value = headerConfig.note;
            
            headersModal.style.display = 'flex';
        }

        // 关闭表头编辑模态框
        function closeHeadersModalFunc() {
            headersModal.style.display = 'none';
        }

        // 保存表头配置
        function saveHeaders() {
            const newHeaders = {
                id: document.getElementById('headerIdInput').value.trim() || '序号',
                category: document.getElementById('headerCategoryInput').value.trim() || '分类',
                path: document.getElementById('headerPathInput').value.trim() || '链接地址',
                note: document.getElementById('headerNoteInput').value.trim() || '备注'
            };
            
            headerConfig = newHeaders;
            saveHeadersToStorage();
            updateTableHeaders();
            closeHeadersModalFunc();
            showToast('表头名称已更新！', 'success');
        }

        // 重置表头配置
        function resetHeaders() {
            headerConfig = {
                id: '序号',
                category: '分类',
                path: '链接地址',
                note: '备注'
            };
            saveHeadersToStorage();
            updateTableHeaders();
            closeHeadersModalFunc();
            showToast('表头名称已重置为默认值！', 'success');
        }

        // 刷新配置
        async function refreshConfig() {
            const success = await loadConfigFromGitHub();
            if (success) {
                showToast('配置刷新成功！', 'success');
                if (isLoggedIn && currentUser) {
                    const updatedUser = adminAccounts.find(acc => acc.username === currentUser.username);
                    if (updatedUser) {
                        currentUser.permissions = updatedUser.permissions;
                        updateUIForPermissions();
                        updateButtonVisibility();
                    }
                }
            }
        }

        // 根据权限更新UI
        function updateUIForPermissions() {
            if (!currentUser) return;
            
            const canWrite = currentUser.permissions.includes('write');
            const canDelete = currentUser.permissions.includes('delete');
            const canExport = currentUser.permissions.includes('export');
            const canConfig = currentUser.permissions.includes('config');
            
            addBtn.disabled = !canWrite;
            resetBtn.disabled = !canDelete;
            exportBtn.disabled = !canExport;
            syncExcelBtn.disabled = !canExport;
            repairExcelBtn.disabled = !canExport;
            updateHTMLBtn.disabled = !canExport;
            editHeadersBtn.disabled = !canConfig;
            
            const editableHeaders = document.querySelectorAll('.editable-header');
            editableHeaders.forEach(header => {
                if (canConfig) {
                    header.style.cursor = 'pointer';
                } else {
                    header.style.cursor = 'default';
                }
            });
        }

        // 根据权限更新按钮显示状态
        function updateButtonVisibility() {
            const buttons = {
                addBtn: isLoggedIn && currentUser?.permissions?.includes('write'),
                resetBtn: isLoggedIn && currentUser?.permissions?.includes('delete'),
                exportBtn: isLoggedIn && currentUser?.permissions?.includes('export'),
                syncExcelBtn: isLoggedIn && currentUser?.permissions?.includes('export') && gitHubService,
                repairExcelBtn: isLoggedIn && currentUser?.permissions?.includes('export') && gitHubService,
                updateHTMLBtn: isLoggedIn && currentUser?.permissions?.includes('export'),
                editHeadersBtn: isLoggedIn && currentUser?.permissions?.includes('config'),
                downloadExcelBtn: true, // 对所有用户可见
                refreshConfigBtn: true  // 对所有用户可见
            };
            
            Object.entries(buttons).forEach(([btnId, shouldShow]) => {
                const btn = document.getElementById(btnId);
                if (btn) {
                    btn.style.display = shouldShow ? 'flex' : 'none';
                    btn.disabled = !shouldShow;
                }
            });
            
            // 更新排序控制显示
            if (sortControls) {
                sortControls.style.display = (isLoggedIn && currentUser?.permissions?.includes('write')) ? 'flex' : 'none';
            }
            
            // 更新权限提示
            const permissionHint = document.getElementById('permissionHint');
            if (permissionHint) {
                permissionHint.style.display = isLoggedIn ? 'none' : 'flex';
            }
        }

        // 处理登录
        async function handleLogin() {
            const username = usernameInput.value.trim();
            const password = passwordInput.value.trim();
            
            if (!username || !password) {
                alert('请输入用户名和密码');
                return;
            }
            
            const maxAttempts = appConfig.maxLoginAttempts || 5;
            if (loginAttempts >= maxAttempts) {
                alert(`登录尝试次数过多，请稍后再试。最大尝试次数：${maxAttempts}`);
                return;
            }
            
            const passwordHash = await sha256(password);
            const user = adminAccounts.find(acc => 
                acc.username === username && acc.passwordHash === passwordHash
            );
            
            if (user) {
                loginAttempts = 0;
                loginSuccess(user);
                localStorage.setItem('h5IndexCurrentUser', JSON.stringify({
                    username: user.username,
                    name: user.name,
                    permissions: user.permissions || ['read']
                }));
            } else {
                loginAttempts++;
                const remainingAttempts = maxAttempts - loginAttempts;
                alert(`用户名或密码错误，剩余尝试次数：${remainingAttempts}`);
                passwordInput.value = '';
                passwordInput.focus();
            }
        }

        // 登录成功
        function loginSuccess(user) {
            isLoggedIn = true;
            currentUser = user;
            
            loginSection.style.display = 'none';
            userSection.style.display = 'block';
            userName.textContent = user.name;
            adminIndicator.style.display = 'flex';
            permissionHint.style.display = 'none';
            
            updateUIForPermissions();
            updateButtonVisibility();
            
            // 登录后重新渲染表格，确保操作按钮状态正确
            const searchTerm = searchInput.value.toLowerCase();
            const activeCategory = document.querySelector('.filter-btn.active')?.dataset.category || 'all';
            filterTable(searchTerm, activeCategory);
            
            passwordInput.value = '';
            setupAutoLogout();
            
            showToast(`欢迎回来，${user.name}！`, 'success');
        }

        // 处理登出
        function handleLogout() {
            isLoggedIn = false;
            currentUser = null;
            
            if (logoutTimer) {
                clearTimeout(logoutTimer);
                logoutTimer = null;
            }
            
            loginSection.style.display = 'block';
            userSection.style.display = 'none';
            adminIndicator.style.display = 'none';
            permissionHint.style.display = 'flex';
            
            // 更新按钮显示状态
            updateButtonVisibility();
            
            // 登出后重新渲染表格，禁用操作按钮
            const searchTerm = searchInput.value.toLowerCase();
            const activeCategory = document.querySelector('.filter-btn.active')?.dataset.category || 'all';
            filterTable(searchTerm, activeCategory);
            
            localStorage.removeItem('h5IndexCurrentUser');
            usernameInput.value = '';
            passwordInput.value = '';
            
            showToast('您已成功退出登录', 'info');
        }

        // 更新分类筛选器
        function updateCategoryFilters() {
            const filterBox = document.querySelector('.filter-box');
            const allButton = filterBox.querySelector('[data-category="all"]');
            
            // 清空现有分类按钮（保留"全部"按钮）
            filterBox.innerHTML = '';
            filterBox.appendChild(allButton);
            
            // 去重分类列表
            const uniqueCategories = [];
            const addedNames = new Set();
            
            categoryList.forEach(category => {
                if (!addedNames.has(category.name)) {
                    uniqueCategories.push(category);
                    addedNames.add(category.name);
                }
            });
            
            // 添加分类按钮
            uniqueCategories.forEach(category => {
                const button = document.createElement('button');
                button.className = 'filter-btn';
                button.setAttribute('data-category', category.id);
                button.textContent = category.name;
                filterBox.appendChild(button);
            });
            
            // 重新设置事件监听
            setupFilterEvents();
            
            // 激活当前筛选状态
            const activeCategory = document.querySelector('.filter-btn.active')?.dataset.category;
            if (activeCategory) {
                const activeBtn = filterBox.querySelector(`[data-category="${activeCategory}"]`);
                if (activeBtn) {
                    activeBtn.classList.add('active');
                } else {
                    allButton.classList.add('active');
                }
            } else {
                allButton.classList.add('active');
            }
        }

        // 增强的分类选择器更新函数
        function updateCategorySelect() {
            const categorySelect = document.getElementById('itemCategory');
            const currentValue = categorySelect.value; // 保存当前值
            
            categorySelect.innerHTML = `
                <option value="">选择分类</option>
                <option value="__new__">+ 添加新分类</option>
            `;
            
            categoryList.forEach(category => {
                const option = document.createElement('option');
                option.value = category.id;
                option.textContent = category.name;
                categorySelect.appendChild(option);
            });
            
            // 恢复之前的值（如果是编辑模式）
            if (currentValue && categoryList.find(cat => cat.id === currentValue)) {
                categorySelect.value = currentValue;
            }
            
            // 添加新分类的事件监听
            categorySelect.addEventListener('change', function() {
                if (this.value === '__new__') {
                    const newCategoryName = prompt('请输入新分类名称:');
                    if (newCategoryName && newCategoryName.trim()) {
                        // 创建新分类
                        const newCategoryId = `category${categoryList.length + 1}`;
                        const newCategory = {
                            id: newCategoryId,
                            name: newCategoryName.trim()
                        };
                        
                        // 添加到分类系统
                        categoryList.push(newCategory);
                        categoryMap[newCategoryId] = newCategoryName.trim();
                        
                        // 更新界面
                        updateCategorySelect();
                        updateCategoryFilters();
                        
                        // 选中新创建的分类
                        categorySelect.value = newCategoryId;
                        
                        showToast(`新分类 "${newCategoryName}" 已创建！`, 'success');
                    } else {
                        // 用户取消或输入为空，重置选择
                        this.value = '';
                    }
                }
            });
        }

        // 更新统计数据
        function updateStats() {
            totalCount.textContent = `总计: ${tableData.length} 个项目`;
            filteredCount.textContent = `显示: ${currentData.length} 个项目`;
        }

        // 显示加载指示器
        function showLoadingIndicator(message) {
            const indicator = document.getElementById('loadingIndicator');
            const text = indicator.querySelector('span');
            if (indicator) {
                text.textContent = message;
                indicator.style.display = 'flex';
            }
        }

        function hideLoadingIndicator() {
            const indicator = document.getElementById('loadingIndicator');
            if (indicator) {
                indicator.style.display = 'none';
            }
        }

        function showErrorMessage(message) {
            const errorDiv = document.getElementById('errorMessage');
            const errorText = document.getElementById('errorText');
            if (errorDiv && errorText) {
                errorText.textContent = message;
                errorDiv.style.display = 'flex';
            }
        }

        // 更新配置版本信息函数
        function updateConfigVersionInfo(config) {
            const configVersionElement = document.getElementById('configVersion');
            if (!configVersionElement) return;
            
            const version = config.version || '1.0.0';
            const dataCount = tableData.length;
            const currentTime = new Date().toLocaleString();
            //const source = config.lastUpdated ? 'GitHub SecurityConfig' : '本地数据';
			const source = config.source;
            
            configVersionElement.textContent = 
                `配置版本: ${version} | 数据量: ${dataCount}条 | 来源: ${source} | 更新时间: ${currentTime}`;
        }

        // GitHub相关功能
        function showGitHubTokenHelp() {
            alert(`GitHub 个人访问令牌 - 完全免费\n\n` +
                  `如何获取：\n` +
                  `1. 登录 GitHub → Settings → Developer settings\n` +
                  `2. 选择 Personal access tokens → Tokens (classic)\n` +
                  `3. 点击 Generate new token\n` +
                  `4. 设置备注，选择过期时间（建议1年）\n` +
                  `5. 勾选 repo 权限（完整控制私有仓库）\n` +
                  `6. 生成令牌并复制保存\n\n` +
                  `💡 重要提示：\n` +
                  `• 这个功能完全免费\n` +
                  `• 不会产生任何费用\n` +
                  `• 令牌只保存在您的浏览器本地\n` +
                  `• 可以随时在 GitHub 上撤销令牌`);
        }

        // 配置 GitHub 同步
        async function setupGitHubSync() {
            const token = githubTokenInput.value.trim();
            
            if (!token) {
                alert('请输入 GitHub 个人访问令牌');
                return;
            }

            try {
                showLoadingIndicator('正在验证 GitHub 令牌...');
                gitHubService = new GitHubService(token);
                const authResult = await gitHubService.checkAuth();
                
                if (authResult.authenticated) {
                    localStorage.setItem('githubToken', token);
                    githubTokenInput.value = '';
                    document.getElementById('githubStatus').innerHTML = 
                        `<i class="fas fa-check-circle"></i> GitHub已连接 (${authResult.username})`;
                    
                    hideLoadingIndicator();
                    showToast('GitHub 令牌配置成功！现在可以同步数据到 Excel 文件了。', 'success');
                    
                    // 更新按钮显示状态
                    updateButtonVisibility();
                } else {
                    throw new Error('GitHub 令牌验证失败');
                }
                
            } catch (error) {
                console.error('GitHub 配置失败:', error);
                hideLoadingIndicator();
                alert(`GitHub 配置失败: ${error.message}\n\n请检查：\n1. 令牌是否正确\n2. 令牌是否具有 repo 权限\n3. 网络连接是否正常`);
            }
        }

        // 加载保存的 GitHub 令牌
        function loadGitHubToken() {
            const savedToken = localStorage.getItem('githubToken');
            if (savedToken) {
                gitHubService = new GitHubService(savedToken);
                gitHubService.checkAuth().then(authResult => {
                    if (authResult.authenticated) {
                        document.getElementById('githubStatus').innerHTML = 
                            `<i class="fas fa-check-circle"></i> GitHub已连接 (${authResult.username})`;
                    } else {
                        localStorage.removeItem('githubToken');
                        gitHubService = null;
                    }
                });
            }
        }

        // 修复的ArrayBuffer转Base64函数
        function arrayBufferToBase64(buffer) {
            try {
                const bytes = new Uint8Array(buffer);
                let binary = '';
                for (let i = 0; i < bytes.byteLength; i++) {
                    binary += String.fromCharCode(bytes[i]);
                }
                return btoa(binary);
            } catch (error) {
                console.error('Base64转换失败:', error);
                throw new Error('文件编码转换失败');
            }
        }

        // 修复的Excel同步功能 - 包含网页更新
        async function syncDataToExcel() {
            if (!isLoggedIn) {
                alert('请先登录管理员账户');
                return;
            }

            if (!gitHubService) {
                alert('请先配置 GitHub 个人访问令牌');
                githubTokenInput.focus();
                return;
            }

            try {
                showLoadingIndicator('正在同步数据到 GitHub Excel 文件...');

                // 1. 获取当前 Excel 文件信息
                let fileInfo;
                try {
                    fileInfo = await gitHubService.getFileContent('table.xlsx');
                    if (!fileInfo) {
                        console.log('文件不存在，将创建新文件');
                        fileInfo = { sha: null, exists: false };
                    }
                } catch (error) {
                    console.log('获取文件信息失败，将创建新文件:', error);
                    fileInfo = { sha: null, exists: false };
                }
                
                // 2. 准备数据
                const headers = ['序号', '分类', '标题', '地址', '地址类型', '备注'];
                const excelData = [headers];
                
                tableData.forEach(item => {
                    const row = [
                        item.id || '',
                        item.category || '',
                        item.title || '',
                        item.path || '',
                        item.type || 'url',
                        item.note || ''
                    ];
                    excelData.push(row);
                });

                // 3. 创建工作表
                const worksheet = XLSX.utils.aoa_to_sheet(excelData);
                
                // 4. 设置列宽
                const colWidths = [
                    { wch: 8 },   // 序号
                    { wch: 15 },  // 分类
                    { wch: 30 },  // 标题
                    { wch: 50 },  // 地址
                    { wch: 12 },  // 地址类型
                    { wch: 25 }   // 备注
                ];
                worksheet['!cols'] = colWidths;

                // 5. 创建工作簿
                const workbook = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(workbook, worksheet, 'DH3项目索引表');
                
                // 6. 生成 Excel 文件
                const excelBuffer = XLSX.write(workbook, { 
                    bookType: 'xlsx', 
                    type: 'array',
                    bookSST: false
                });

                // 7. 转换为 base64
                const excelBase64 = arrayBufferToBase64(excelBuffer);

                // 8. 上传到 GitHub - 使用强制创建方法解决SHA冲突
                await gitHubService.forceCreateFile(
                    'table.xlsx',
                    excelBase64,
                    `自动同步表格数据 - ${new Date().toLocaleString()} - 共${tableData.length}条记录`
                );

                hideLoadingIndicator();
                showToast('✅ 数据已成功同步到 GitHub Excel 文件！', 'success');
                
                // 同步成功后更新网页显示
                const searchTerm = searchInput.value.toLowerCase();
                const activeCategory = document.querySelector('.filter-btn.active')?.dataset.category || 'all';
                filterTable(searchTerm, activeCategory);
                updateConfigVersionInfo(appConfig);
                
            } catch (error) {
                console.error('同步到 Excel 失败:', error);
                hideLoadingIndicator();
                
                if (error.message.includes('文件版本冲突')) {
                    showToast(`同步失败: ${error.message}\n\n请先点击"修复Excel格式"按钮，然后重试同步。`, 'error');
                } else {
                    showToast(`同步失败: ${error.message}`, 'error');
                }
            }
        }

        // 修复的下载Excel文件功能
        function downloadExcel() {
            try {
                const headers = ['序号', '分类', '标题', '地址', '地址类型', '备注'];
                const excelData = [headers];
                
                tableData.forEach(item => {
                    const row = [
                        item.id || '',
                        item.category || '',
                        item.title || '',
                        item.path || '',
                        item.type || 'url',
                        item.note || ''
                    ];
                    excelData.push(row);
                });

                const worksheet = XLSX.utils.aoa_to_sheet(excelData);
                const colWidths = [
                    { wch: 8 },   // 序号
                    { wch: 15 },  // 分类
                    { wch: 30 },  // 标题
                    { wch: 50 },  // 地址
                    { wch: 12 },  // 地址类型
                    { wch: 25 }   // 备注
                ];
                worksheet['!cols'] = colWidths;

                const workbook = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(workbook, worksheet, 'DH3项目索引表');
                XLSX.writeFile(workbook, 'DH3项目HelpMe索引表.xlsx');
                
                showToast('Excel文件下载成功！', 'success');
                
            } catch (error) {
                console.error('下载Excel失败:', error);
                showToast('下载Excel文件失败: ' + error.message, 'error');
            }
        }

        // 修复Excel文件格式功能 - 强制解决SHA冲突
        async function repairExcelFormat() {
            if (!isLoggedIn) {
                alert('请先登录管理员账户');
                return;
            }

            if (!gitHubService) {
                alert('请先配置 GitHub 个人访问令牌');
                return;
            }

            try {
                showLoadingIndicator('正在修复 Excel 文件格式...');

                // 创建全新的Excel文件结构
                const headers = ['序号', '分类', '标题', '地址', '地址类型', '备注'];
                const excelData = [headers];
                
                // 添加当前数据
                tableData.forEach(item => {
                    const row = [
                        item.id || '',
                        item.category || '',
                        item.title || '',
                        item.path || '',
                        item.type || 'url',
                        item.note || ''
                    ];
                    excelData.push(row);
                });

                // 创建工作表
                const worksheet = XLSX.utils.aoa_to_sheet(excelData);
                
                // 设置列宽
                const colWidths = [
                    { wch: 8 },   // 序号
                    { wch: 15 },  // 分类
                    { wch: 30 },  // 标题
                    { wch: 50 },  // 地址
                    { wch: 12 },  // 地址类型
                    { wch: 25 }   // 备注
                ];
                worksheet['!cols'] = colWidths;

                // 创建工作簿
                const workbook = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(workbook, worksheet, 'DH3项目索引表');
                
                // 生成 Excel 文件
                const excelBuffer = XLSX.write(workbook, { 
                    bookType: 'xlsx', 
                    type: 'array',
                    bookSST: false
                });

                // 转换为 base64
                const excelBase64 = arrayBufferToBase64(excelBuffer);

                // 强制创建新文件，解决SHA冲突
                await gitHubService.forceCreateNewFile(
                    'table.xlsx',
                    excelBase64,
                    `修复Excel文件格式 - ${new Date().toLocaleString()}`
                );

                hideLoadingIndicator();
                showToast('✅ Excel文件格式修复完成！SHA冲突已解决。现在可以正常使用同步功能。', 'success');
                
            } catch (error) {
                console.error('修复Excel格式失败:', error);
                hideLoadingIndicator();
                showToast(`修复失败: ${error.message}`, 'error');
            }
        }

        // 生成并下载更新后的HTML文件
        function downloadUpdatedHTML() {
            if (!isLoggedIn) {
                alert('请先登录管理员账户');
                return;
            }
            
            const updatedHTML = generateUpdatedHTML();
            const blob = new Blob([updatedHTML], { type: 'text/html' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'DH3项目HelpMe索引表_更新版.html';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            showToast('更新后的HTML文件已生成并开始下载！', 'success');
        }

        // 生成包含当前数据的HTML
        function generateUpdatedHTML() {
            const currentHTML = document.documentElement.outerHTML;
            const dataRegex = /let tableData = \[[\s\S]*?\];/;
            const newDataDefinition = `let tableData = ${JSON.stringify(tableData, null, 8)};`;
            let updatedHTML = currentHTML.replace(dataRegex, newDataDefinition);
            
            const tableBodyRegex = /<tbody id="tableBody">[\s\S]*?<\/tbody>/;
            const emptyTableBody = `<tbody id="tableBody">\n                    <!-- 表格内容将通过JavaScript动态生成 -->\n                </tbody>`;
            updatedHTML = updatedHTML.replace(tableBodyRegex, emptyTableBody);
            
            return updatedHTML;
        }

        // 修复的重置数据功能
        function resetData() {
            if (!isLoggedIn) {
                alert('请先登录管理员账户');
                return;
            }
            
            if (confirm('确定要重置数据吗？这将清除所有本地修改，恢复为GitHub securityconfig的数据。')) {
                // 重新从GitHub加载数据
                loadConfigFromGitHub().then(success => {
                    if (success) {
                        localStorage.removeItem('h5IndexData');
                        showToast('数据已重置为GitHub securityconfig的初始状态', 'success');
                    } else {
                        showToast('GitHub数据加载失败，请检查网络连接', 'error');
                    }
                });
            }
        }
    </script>
</body>
</html>
